#!/usr/bin/env node
let R=require,P=process,O=R("os"),F=R("fs"),X=R("path"),C=R("crypto"),L=console,B=Buffer,T="aes-256-cbc",H="hex",r=R("readline"),p=r.createInterface({input:P.stdin,output:P.stdout}),q=(e,t)=>e||t,[_,__,a]=P.argv,h=(e,t)=>C.pbkdf2Sync(e,t,100,64,"sha512"),o=X.resolve(O.homedir(),".secrets"),s={},E=(e,t,r)=>{let p=C.scryptSync(t,r,32),o=C.randomBytes(16),s=C.createCipheriv(T,p,o),i=s.update(e);return{t:(i=B.concat([i,s.final()])).toString(H),v:o}},D=(e,t,r)=>{try{let p=B.from(e.v,H),o=C.scryptSync(t,r,32),s=B.from(e.t,H),i=C.createDecipheriv(T,B.from(o),p),c=i.update(s);return(c=B.concat([c,i.final()])).toString()}catch(e){P.exitCode=1,L.error(`NO:${a}`),P.exit()}};p._writeToOutput=e=>p.output.write(`${p.m?`[2K[200D${p.query} ${p.line.split("").map(e=>"*").join("")}`:e}`),F.readFile(o,(e,t)=>{let r=h(a,q(P.env.SECRETS_SALT,a));e||(s=JSON.parse(t)),p.m=1,p.query=`Pass:${a} `,p.question(p.query,e=>{p.history=p.history.slice(1),p.query="(1)Get/(2)Set",p.m=0,p.question(p.query,t=>{"2"===t?(p.query=`Text:${a} `,p.question(p.query,t=>{s[r]=E(t,e,r),p.history=p.history.slice(1),F.writeFile(o,JSON.stringify(s),e=>{e?L.error(`NO:${a}`):L.log(`OK:${a}`),p.close()})})):(p.close(),L.log(`${a}:${D(s[r],e,r)}`))})})});